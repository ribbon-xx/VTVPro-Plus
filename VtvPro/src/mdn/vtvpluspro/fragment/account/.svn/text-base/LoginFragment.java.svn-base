package mdn.vtvpluspro.fragment.account;

import mdn.vtvpluspro.R;
import mdn.vtvpluspro.common.DialogManager;
import mdn.vtvpluspro.common.ParserManager;
import mdn.vtvpluspro.common.SharedPreferenceManager;
import mdn.vtvpluspro.fragment.BaseFragment;
import mdn.vtvpluspro.fragment.HomeFragment;
import mdn.vtvpluspro.network.IApiCallback;
import mdn.vtvpluspro.network.WebServiceParam;
import mdn.vtvpluspro.object.account.LoginInfo;
import mdn.vtvpluspro.object.account.UserInfo;
import mdn.vtvpluspro.util.StringUtil;
import android.os.Bundle;
import android.view.LayoutInflater;
import android.view.View;
import android.view.View.OnClickListener;
import android.view.ViewGroup;
import android.widget.Button;
import android.widget.EditText;
import android.widget.Toast;

public class LoginFragment extends BaseFragment implements OnClickListener {
	private EditText edUser;
	private EditText edPass;

	private boolean isFromPlayerFragment = false;

	@Override
	public View onCreateView(LayoutInflater inflater, ViewGroup container,
			Bundle savedInstanceState) {
		// TODO Auto-generated method stub
		View view = inflater.inflate(R.layout.fragment_login, container, false);
		bindView(view);
		initView();
		return view;
	}

	@Override
	protected void initUiTabbar() {
		// TODO Auto-generated method stub
		super.initUiTabbar();

		baseSlideMenuActivity.iconInteract.setVisibility(View.GONE);
		baseSlideMenuActivity.closeViewSearch();
		baseSlideMenuActivity.iconSetting.setVisibility(View.VISIBLE);
		baseSlideMenuActivity.iconBack.setVisibility(View.GONE);
		baseSlideMenuActivity.iconVtvPlus.setVisibility(View.VISIBLE);
	}

	private void bindView(View view) {
		edUser = (EditText) view.findViewById(R.id.edUserName);
		edPass = (EditText) view.findViewById(R.id.edPassword);
		Button btLogin = (Button) view.findViewById(R.id.btLogin);
		btLogin.setOnClickListener(this);
		Button btReg = (Button) view.findViewById(R.id.btRegis);
		btReg.setOnClickListener(this);
	}

	private void initView() {
		Bundle bundle = getArguments();
		if (bundle != null) {
			edUser.setText(bundle.getString(WebServiceParam.PARAM_USER_NAME));
			edPass.setText(bundle.getString(WebServiceParam.PARAM_PASS));
			callLogin();

			try {
				isFromPlayerFragment = bundle.getBoolean("from_player");
			} catch (Exception e) {
				e.printStackTrace();
			}

		}
	}

	@Override
	public void onClick(View v) {
		// TODO Auto-generated method stub
		switch (v.getId()) {
		case R.id.btLogin:
			callLogin();
			break;
		case R.id.btRegis:
			callReg();
			break;

		default:
			break;
		}
	}

	private void callLogin() {
		if (!checkValue()) {
			return;
		}
		baseSlideMenuActivity.callLoginApi(new IApiCallback() {

			@Override
			public void responseSuccess(String response) {
				// TODO Auto-generated method stub
				LoginInfo info = ParserManager.parserLoginInfo(response);
				if (info.isSuccess()) {
					baseSlideMenuActivity.pProfile.pUserName = edUser.getText()
							.toString().trim();
					baseSlideMenuActivity.pProfile.pPassword = edPass.getText()
							.toString().trim();
					baseSlideMenuActivity.pProfile.pSession = info.getMessage();
					SharedPreferenceManager.getInstance(baseSlideMenuActivity)
							.setUserInfo(
									baseSlideMenuActivity.pProfile.pUserName,
									baseSlideMenuActivity.pProfile.pPassword);
					baseSlideMenuActivity.mMenuFragment.initLayout();

					if (isFromPlayerFragment)
						// update user info and return to player screen
						callGetUserInfo();
					else
						baseSlideMenuActivity.switchContent(
								new UserInfoFragment(), false);
					HomeFragment.IS_CHANGE_DATA = true;
				} else {
					DialogManager.alert(baseSlideMenuActivity,
							info.getMessage());
				}
			}

			@Override
			public void responseFailWithCode(int statusCode) {
				// TODO Auto-generated method stub
				DialogManager.alert(baseSlideMenuActivity,
						getString(R.string.network_fail));
			}
		}, edUser.getText().toString(), edPass.getText().toString());
	}

	private void callReg() {
		baseSlideMenuActivity.switchContent(new RegisterFragment(), false);
	}

	private boolean checkValue() {
		String strEmail = edUser.getText().toString().trim();
		String strPass = edPass.getText().toString().trim();
		if (strEmail.length() == 0 || strPass.length() == 0) {
			Toast.makeText(baseSlideMenuActivity,
					getString(R.string.full_info), Toast.LENGTH_SHORT).show();
			return false;
		}

		if (!StringUtil.checkEmail(strEmail)) {
			Toast.makeText(baseSlideMenuActivity,
					getString(R.string.erorr_email), Toast.LENGTH_SHORT).show();
			return false;
		}

		return true;
	}

	private void callGetUserInfo() {
		baseSlideMenuActivity.callAccountInfoApi(new IApiCallback() {

			@Override
			public void responseSuccess(String response) {
				// TODO Auto-generated method stub
				UserInfo info = ParserManager.parserUserInfo(response);
				if (info.isGetSucc()) {
					if (info.isRegister()) {
						baseSlideMenuActivity.pProfile.pTypePack = 1;
						baseSlideMenuActivity.pProfile.pIdChannel = info
								.getLiveChannel();
						baseSlideMenuActivity.pProfile.pNamePack = info
								.getCurrentService();
						baseSlideMenuActivity.pProfile.pDayPack = info
								.getExpiryDate();
					} else {
						baseSlideMenuActivity.pProfile.pTypePack = 2;
					}

					baseSlideMenuActivity.onPressBack();
				} else {
					DialogManager.alert(baseSlideMenuActivity,
							info.getLiveChannel());
				}
			}

			@Override
			public void responseFailWithCode(int statusCode) {
				// TODO Auto-generated method stub
				DialogManager.alert(baseSlideMenuActivity,
						getString(R.string.network_fail));
			}
		});
	}
}
